Return-Path: <linux-pci+bounces-34370-lists+linux-pci=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-pci@lfdr.de
Delivered-To: lists+linux-pci@lfdr.de
Received: from ny.mirrors.kernel.org (ny.mirrors.kernel.org [147.75.199.223])
	by mail.lfdr.de (Postfix) with ESMTPS id 4BE21B2D760
	for <lists+linux-pci@lfdr.de>; Wed, 20 Aug 2025 11:00:50 +0200 (CEST)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by ny.mirrors.kernel.org (Postfix) with ESMTPS id 36E71582A72
	for <lists+linux-pci@lfdr.de>; Wed, 20 Aug 2025 08:57:47 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id BFF302877D2;
	Wed, 20 Aug 2025 08:57:01 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="pmkTE9jJ"
X-Original-To: linux-pci@vger.kernel.org
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9B9CE24339D
	for <linux-pci@vger.kernel.org>; Wed, 20 Aug 2025 08:57:01 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1755680221; cv=none; b=IT+3WD1iq/3jJW+WARR9saZgXLFvQsSNUheI1us8c8qcDv0SfWRQ8yoXhlTy8/mcQkS3sBvO+pXYgRQbGeFLXXtmtrPS1kr3O/u3pLRhq0jm46Of+wbS0PVYungb30eFv4CUh+4jIhLKgZZPVrw1nPG98+jidB3tUpTmvkoeItU=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1755680221; c=relaxed/simple;
	bh=BHwPoKTEj91/GJKNcfj8Dutl5ARN4HeFYrbIABszgyQ=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=Oc3y/N/+hZI+94FwU8QynXgeHP8G6FSJ3dGsLxl8yfof5UpVVl6luSGSZPSRnLPsbO51XbKX8yx4MNtR582cwWK9EkN0DPOhoKfcZiq1ckxSaL1cUGoDHfpml5fvMye7FNnpmp1a+VHxHxVZeqgQxDTtAnjKexWxSX5lWARAo74=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=pmkTE9jJ; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 6FC50C4CEEB;
	Wed, 20 Aug 2025 08:57:01 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1755680221;
	bh=BHwPoKTEj91/GJKNcfj8Dutl5ARN4HeFYrbIABszgyQ=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=pmkTE9jJU5lk0aBrpb6xdBQ7V52EGOI29RmwuHE5yHKLH0xwOCUQaQKWx9/0GdZ/l
	 tFk0G1SBDkN5s5yzpqY3VRLBIB+pVY5RmTRk8OOQSRzb2phI6twM3XkwlqrHHW2WQV
	 C00qSxkC/Yrf2nNmAI/bvRlhOJsrf/EmT1PgBWBk+Spb6yRE63tzcezinWzYPrC89h
	 /GjRy669yXDIWKNKM5eCBxk63FGSO6RTV2HB4Ij2p+lFdXQUQeZdwFRnCW0jKrj8Dc
	 u5PscMpxtfG4SG0wQCN4sCneBYdRiZZG9RDKXg0SM5/DDd6LUquXN2/brmRI9s5a/j
	 ckawFDNrAy/xw==
Received: from host86-149-246-145.range86-149.btcentralplus.com ([86.149.246.145] helo=lobster-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1uoecl-009Gtj-19;
	Wed, 20 Aug 2025 09:56:51 +0100
Date: Wed, 20 Aug 2025 09:56:50 +0100
Message-ID: <87qzx6jrql.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Coiby Xu <coxu@redhat.com>
Cc: Thomas Gleixner <tglx@linutronix.de>,
	linux-arm-kernel@lists.infradead.org,
	linux-pci@vger.kernel.org,
	kexec@lists.infradead.org
Subject: Re: [Regression] kdump fails to get DHCP address unless booting with pci=nomsi or without nr_cpus=1
In-Reply-To: <j4atkwhumotioe2nhu6esrb3yrvwsoz2eyqeopwmr7o6iw65ga@wdkvgahnyhln>
References: <x5dwuzyddiasdkxozpjvh3usd7b5zdgim2ancrcbccfjxq7qwn@i6b24w22sy6s>
	<87bjom8106.ffs@tglx>
	<878qjq80yu.ffs@tglx>
	<86v7mt9ai3.wl-maz@kernel.org>
	<i2l2ujhqjd6akzosvzj4njv2vemsfuvywz4gsnj2nwo3fwyjyz@cfhekxpartf2>
	<86ms84974v.wl-maz@kernel.org>
	<gec2yl5wx6vvt67smx5emhcoifvtp4orw6sub24b2nrqwryhp2@i4h7qbtwjo3r>
	<86ldno8yxa.wl-maz@kernel.org>
	<yweverlt7onyse3rbm7phxzwrwfk4pq2dipzdjenrx4onrak6r@dsm4ra3x3gv6>
	<j4atkwhumotioe2nhu6esrb3yrvwsoz2eyqeopwmr7o6iw65ga@wdkvgahnyhln>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/30.1
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: linux-pci@vger.kernel.org
List-Id: <linux-pci.vger.kernel.org>
List-Subscribe: <mailto:linux-pci+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-pci+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 86.149.246.145
X-SA-Exim-Rcpt-To: coxu@redhat.com, tglx@linutronix.de, linux-arm-kernel@lists.infradead.org, linux-pci@vger.kernel.org, kexec@lists.infradead.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Wed, 20 Aug 2025 00:30:12 +0100,
Coiby Xu <coxu@redhat.com> wrote:
> 
> On Wed, Aug 13, 2025 at 08:08:28PM +0800, Coiby Xu wrote:
> > On Tue, Aug 12, 2025 at 02:14:25PM +0100, Marc Zyngier wrote:
> [...]
> >> 
> >> Can you at the very least share:
> 
> Thanks for your patience! I've attached a zip file with the info you
> need. Additionally I've included the dmidecode of guest
> (dmidecode_guest), host machine (dmidecode_host) and the domain info
> of guest (libvirt.xml) in case they may be helpful. If you need further
> info or any experiment I need to do, feel free to let me know! Now I
> have access to the host machine so I can respond much faster.
> 
> >> 
> >> - the boot log of the guest on its first kernel
> 
> Please check file boot_log_1st_kernel

Old kernel. It would have been better to use a vanilla v6.16, so that
we know exactly what you are running. I have zero interest in finding
out what 6.15.9-201.fc42.aarch64 corresponds to in real life.

> >> - the boot log of the guest running kdump
> 
> boot_log_2nd_kernel

Same thing.

> 
> >> 
> >> - the content of /sys/kernel/debug/kvm/$PID-xx/vgic*state* when
> >> running both kernels
> 
> vgic-state_{1st,2nd}_kernel

What is the host running? It also looks like a pre-6.16 kernel, which
lacks important information.

> 
> >> 
> >> - the QEMU command-line to get to run the whole thing
> 
> qemu_cmdline

I'm sorry, but that doesn't look like a command line as I know it. I
certainly cannot feed this to QEMU and reproduce your findings.

Now, there is *one* thing that is interesting:

The second vgic_state dump indicates that LPI 8225 is routed to
vcpu-3. Given that your guest boots into the second kernel on vcpu-0,
and that this is the only online vcpu at this stage, the LPI will
never be presented to the CPU (and the vgic has it as pending, which
is what I'd expect).

I'd suggest you instrument the second kernel to try and see why this
affinity is not changed.

Thanks,

	M.

-- 
Jazz isn't dead. It just smells funny.

