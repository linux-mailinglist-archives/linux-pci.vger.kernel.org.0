Return-Path: <linux-pci+bounces-43255-lists+linux-pci=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-pci@lfdr.de
Delivered-To: lists+linux-pci@lfdr.de
Received: from sto.lore.kernel.org (sto.lore.kernel.org [172.232.135.74])
	by mail.lfdr.de (Postfix) with ESMTPS id 5906CCCAA90
	for <lists+linux-pci@lfdr.de>; Thu, 18 Dec 2025 08:32:20 +0100 (CET)
Received: from smtp.subspace.kernel.org (conduit.subspace.kernel.org [100.90.174.1])
	by sto.lore.kernel.org (Postfix) with ESMTP id C4EFD30349C1
	for <lists+linux-pci@lfdr.de>; Thu, 18 Dec 2025 07:32:19 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 20E242E7F14;
	Thu, 18 Dec 2025 07:32:13 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="aS22cRSa"
X-Original-To: linux-pci@vger.kernel.org
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id DF3A431A06A;
	Thu, 18 Dec 2025 07:32:11 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1766043133; cv=none; b=by0VJ0c7uO7NFeLcuX5rWqFwAolRQygrm3AFdLxut3QvNS+qBaUHQCZcHDohGOLNkRm5jbYs7PndrnXyGbisZ7zLLQyu03YR1Dq90y/z6rjY5hH3wEgwsmYlSzJprYISu1l2KX6XWu0UHRfpIGT+28o97zldW2Xmg7McK0HrB6I=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1766043133; c=relaxed/simple;
	bh=DYWkA/4UXO23vBw3QVFtA8kWg3Imxpzwc9FdCTUxaYw=;
	h=Date:From:To:Cc:Subject:Message-ID:References:MIME-Version:
	 Content-Type:Content-Disposition:In-Reply-To; b=enURc855hYLp7+Bjrwt0ik4UmhXn1hJRjZRLXgdU0pA0kc12etQ38uOArG8H3wnUOf+YMqOwNiPIC5G1UyJjbkhxQUfXZJjFoSQuBbik6j3ynlV9pZPZhNJwf5iyzyF/ghcph6g5h9QLvOMa44047hulZPK3wGQaUPSfWwFqkg8=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=aS22cRSa; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 5CF06C4CEFB;
	Thu, 18 Dec 2025 07:32:07 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1766043131;
	bh=DYWkA/4UXO23vBw3QVFtA8kWg3Imxpzwc9FdCTUxaYw=;
	h=Date:From:To:Cc:Subject:References:In-Reply-To:From;
	b=aS22cRSaHibUSnGlqVBDS6D8FBuypWR2DIZQZSJKvTB/3z+My2f5LwCuc3JiWwMVF
	 NEsGiUBH4u0LtRdvyG3qRA1P3SsKxEzuSrFwg+ch7jOz6cmPIS/6Jr8wkmVnMHrzU/
	 gQIJn1yEeCWiFu2SrDFveasBfV8B/N6cmxCTM6WMBGqC7uMH0uhHVN5JlsEPEOE17C
	 nhH19btRx39655ocWp2y0orwZeaNt3CFAqWuIbkSSH/LtLzI345nqDiPTdoZV1z/+V
	 VSz2FZoAZR475q3Pd7ue8Rh/a1AwFMjGEMnscsDdeXvZXTtiYjCEScyXo3CpI0qW6m
	 o9UEceALTUQ0g==
Date: Thu, 18 Dec 2025 13:01:57 +0530
From: Manivannan Sadhasivam <mani@kernel.org>
To: Brian Norris <briannorris@chromium.org>
Cc: Qiang Yu <qiang.yu@oss.qualcomm.com>, 
	Lorenzo Pieralisi <lpieralisi@kernel.org>, Krzysztof =?utf-8?Q?Wilczy=C5=84ski?= <kwilczynski@kernel.org>, 
	Rob Herring <robh@kernel.org>, Bjorn Helgaas <bhelgaas@google.com>, 
	Jingoo Han <jingoohan1@gmail.com>, linux-pci@vger.kernel.org, linux-kernel@vger.kernel.org, 
	linux-arm-msm@vger.kernel.org
Subject: Re: [PATCH 3/5] PCI: dwc: Remove MSI/MSIX capability if iMSI-RX is
 used as MSI controller
Message-ID: <nyada24tqwlkzdceyoxbzitzygvp4elvj5oajnqdwb33xkcdwk@76vnrx45fsfd>
References: <20251109-remove_cap-v1-0-2208f46f4dc2@oss.qualcomm.com>
 <20251109-remove_cap-v1-3-2208f46f4dc2@oss.qualcomm.com>
 <aTDpCpLUzxnAmvt6@google.com>
Precedence: bulk
X-Mailing-List: linux-pci@vger.kernel.org
List-Id: <linux-pci.vger.kernel.org>
List-Subscribe: <mailto:linux-pci+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-pci+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <aTDpCpLUzxnAmvt6@google.com>

On Wed, Dec 03, 2025 at 05:51:06PM -0800, Brian Norris wrote:
> Hi,
> 
> On Sun, Nov 09, 2025 at 10:59:42PM -0800, Qiang Yu wrote:
> > Some platforms may not support ITS (Interrupt Translation Service) and
> > MBI (Message Based Interrupt), or there are not enough available empty SPI
> > lines for MBI, in which case the msi-map and msi-parent property will not
> > be provided in device tree node. For those cases, the DWC PCIe driver
> > defaults to using the iMSI-RX module as MSI controller. However, due to
> > DWC IP design, iMSI-RX cannot generate MSI interrupts for Root Ports even
> > when MSI is properly configured and supported as iMSI-RX will only monitor
> > and intercept incoming MSI TLPs from PCIe link, but the memory write
> > generated by Root Port are internal system bus transactions instead of
> > PCIe TLPs, so they are ignored.
> > 
> > This leads to interrupts such as PME, AER from the Root Port not received
> > on the host and the users have to resort to workarounds such as passing
> > "pcie_pme=nomsi" cmdline parameter.
> > 
> > To ensure reliable interrupt handling, remove MSI and MSI-X capabilities
> > from Root Ports when using iMSI-RX as MSI controller, which is indicated
> > by has_msi_ctrl == true. This forces a fallback to INTx interrupts,
> 
> But "has_msi_ctrl == false" does not necessarily mean it's using an
> external MSI controller, does it? It could just mean that there's some
> per-SoC customization needed via the .msi_init() hook.
> 

But we really do not know if that is a per-SoC customization or entirely
different MSI controller. So it is safe to ignore them and that's what this
patch also does.

> In practice, that's only pci-keystone.c though, and it's not really
> clear if that's some modified version of iMSI-RX, or something else
> entirely. At any rate, I suppose it's best to only tweak the things we
> know about -- unmodified DWC iMSI-RX support.
> 
> > eliminating the need for manual kernel command line workarounds.
> > 
> > With this behavior:
> > - Platforms with ITS/MBI support use ITS/MBI MSI for interrupts from all
> >   components.
> > - Platforms without ITS/MBI support fall back to INTx for Root Ports and
> >   use iMSI-RX for other PCI devices.
> > 
> > Signed-off-by: Qiang Yu <qiang.yu@oss.qualcomm.com>
> > ---
> >  drivers/pci/controller/dwc/pcie-designware-host.c | 10 ++++++++++
> >  1 file changed, 10 insertions(+)
> > 
> > diff --git a/drivers/pci/controller/dwc/pcie-designware-host.c b/drivers/pci/controller/dwc/pcie-designware-host.c
> > index 20c9333bcb1c4812e2fd96047a49944574df1e6f..3724aa7f9b356bfba33a6515e2c62a3170aef1e9 100644
> > --- a/drivers/pci/controller/dwc/pcie-designware-host.c
> > +++ b/drivers/pci/controller/dwc/pcie-designware-host.c
> > @@ -1083,6 +1083,16 @@ int dw_pcie_setup_rc(struct dw_pcie_rp *pp)
> >  
> >  	dw_pcie_dbi_ro_wr_dis(pci);
> >  
> > +	/*
> > +	 * If iMSI-RX module is used as the MSI controller, remove MSI and
> > +	 * MSI-X capabilities from PCIe Root Ports to ensure fallback to INTx
> > +	 * interrupt handling.
> > +	 */
> 
> Personally, I'd suggest including more of the "why?" in this comment, as
> the "why?" is pretty perplexing to an uninitiated reader.
> 
> Maybe:
> 
> 	/*
> 	 * The iMSI-RX module does not support MSI or MSI-X generated by
> 	 * the root port. If iMSI-RX is used as the MSI controller,
> 	 * remove the MSI and MSI-X capabilities to fall back to INTx
> 	 * instead.
> 	 */
> 

I've ammended the commit with the above comment.

> > +	if (pp->has_msi_ctrl) {
> > +		dw_pcie_remove_capability(pci, PCI_CAP_ID_MSI);
> > +		dw_pcie_remove_capability(pci, PCI_CAP_ID_MSIX);
> 
> Removing the capability structure is a neat idea. I had prototyped
> solving this problem by adding a new PCI_MSI_FLAGS_* quirk, but that was
> a lot more invasive. I like this idea instead!
> 
> This looks good to me, although maybe the comment could be updated. Feel
> free to carry my:
> 
> Reviewed-by: Brian Norris <briannorris@chromium.org>
> 
> I'd also note, not all devices currently actually define their INTx
> interrupts (such as ... my current test devices :( ), and so
> pcie_init_service_irqs() / portdrv.c may fail entirely, since it can't
> really provide any services if there are no IRQs for those services.
> That does have at least one bad side effect: that the port won't be
> configured for runtime PM and won't ever enter D3.
> 
> I wonder if we should allow pcie_port_device_register() to succeed even
> if it ends up with an empty 'capabilities' / no services.
> 

Sounds logical to me as pcie_port_device_register() already returns 0 if there
are no PCI Express port capability.

- Mani

-- 
மணிவண்ணன் சதாசிவம்

