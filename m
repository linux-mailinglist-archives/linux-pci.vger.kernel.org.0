Return-Path: <linux-pci-owner@vger.kernel.org>
X-Original-To: lists+linux-pci@lfdr.de
Delivered-To: lists+linux-pci@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 5619A45866D
	for <lists+linux-pci@lfdr.de>; Sun, 21 Nov 2021 22:09:46 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229835AbhKUVMr (ORCPT <rfc822;lists+linux-pci@lfdr.de>);
        Sun, 21 Nov 2021 16:12:47 -0500
Received: from mail.kernel.org ([198.145.29.99]:52080 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S229586AbhKUVMp (ORCPT <rfc822;linux-pci@vger.kernel.org>);
        Sun, 21 Nov 2021 16:12:45 -0500
Received: from disco-boy.misterjones.org (disco-boy.misterjones.org [51.254.78.96])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by mail.kernel.org (Postfix) with ESMTPSA id 59962604D1;
        Sun, 21 Nov 2021 21:09:39 +0000 (UTC)
Received: from sofa.misterjones.org ([185.219.108.64] helo=wait-a-minute.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.94.2)
        (envelope-from <maz@kernel.org>)
        id 1mou5h-006w8r-7f; Sun, 21 Nov 2021 21:09:37 +0000
Date:   Sun, 21 Nov 2021 21:09:38 +0000
Message-ID: <878rxhrzal.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Maxym Synytsky <synytsky@dedrozeba.org.ua>
Cc:     Krzysztof =?UTF-8?B?V2lsY3p5xYRza2k=?= <kw@linux.com>,
        Yuji Nakao <contact@yujinakao.com>,
        Damien Le Moal <damien.lemoal@opensource.wdc.com>,
        linux-kernel@vger.kernel.org,
        "linux-pci@vger.kernel.org" <linux-pci@vger.kernel.org>,
        ". Bjorn Helgaas" <bhelgaas@google.com>,
        Arnd Bergmann <arnd@arndb.de>, Sasha Levin <sashal@kernel.org>
Subject: Re: Kernel 5.15 doesn't detect SATA drive on boot
In-Reply-To: <20211121224802.24b0565b@refinery>
References: <87h7ccw9qc.fsf@yujinakao.com>
        <8951152e-12d7-0ebe-6f61-7d3de7ef28cb@opensource.wdc.com>
        <YZQ+GhRR+CPbQ5dX@rocinante>
        <8735nv880m.wl-maz@kernel.org>
        <YZTNCO4OBUrVkCuA@rocinante>
        <20211121174118.231086eb@refinery>
        <87a6hxs2l4.wl-maz@kernel.org>
        <20211121224802.24b0565b@refinery>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: synytsky@dedrozeba.org.ua, kw@linux.com, contact@yujinakao.com, damien.lemoal@opensource.wdc.com, linux-kernel@vger.kernel.org, linux-pci@vger.kernel.org, bhelgaas@google.com, arnd@arndb.de, sashal@kernel.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
Precedence: bulk
List-ID: <linux-pci.vger.kernel.org>
X-Mailing-List: linux-pci@vger.kernel.org

On Sun, 21 Nov 2021 20:48:02 +0000,
Maxym Synytsky <synytsky@dedrozeba.org.ua> wrote:
> 
> On Sun, 21 Nov 2021 19:58:31 +0000
> Marc Zyngier <maz@kernel.org> wrote:
> 
> > > Hi.
> > > I am also experiencing this issue on Gigabyte GA-M720-US3 mobo which uses
> > > NVIDIA nForce 720D chipset. As I understand from the quirks patch it does
> > > not fix my controller?  
> > 
> > Are you sure? The dmesg you attached to this email shows otherwise:
> > 
> Yes, this dmesg is for 5.14 kernel which works fine.

Well, that's not exactly useful to debug your problem, is it? What
makes you think that you are suffering from the same issue if you
can't look at the kernel messages?

> For some reason Arch complains in initramfs that root is locked and I am not
> dropped to recovery shell so getting dmesg for 5.15 would be tricky for me.

Can you please try 5.16-rc1? If it doesn't work, try the following
hack on top of -rc1. But that's a complete shot in the dark, and
without more details on what is going on, there is only so much I can
do.

	M.

diff --git a/drivers/pci/quirks.c b/drivers/pci/quirks.c
index 003950c738d2..6ac0f0b14130 100644
--- a/drivers/pci/quirks.c
+++ b/drivers/pci/quirks.c
@@ -5852,8 +5852,10 @@ DECLARE_PCI_FIXUP_ENABLE(PCI_VENDOR_ID_PERICOM, 0x2303,
 DECLARE_PCI_FIXUP_RESUME(PCI_VENDOR_ID_PERICOM, 0x2303,
 			 pci_fixup_pericom_acs_store_forward);
 
-static void nvidia_ion_ahci_fixup(struct pci_dev *pdev)
+static void nvidia_ahci_fixup(struct pci_dev *pdev)
 {
 	pdev->dev_flags |= PCI_DEV_FLAGS_HAS_MSI_MASKING;
 }
-DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_NVIDIA, 0x0ab8, nvidia_ion_ahci_fixup);
+DECLARE_PCI_FIXUP_CLASS_FINAL(PCI_VENDOR_ID_NVIDIA, PCI_ANY_ID,
+			      PCI_CLASS_STORAGE_SATA_AHCI, 8,
+			      nvidia_ahci_fixup);

-- 
Without deviation from the norm, progress is not possible.
